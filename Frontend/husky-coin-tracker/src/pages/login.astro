---
import Layout from '../components/Layout.astro';
import { login } from "../scripts/pocket";

let user = null
let error = null

if (Astro.locals.pb.authStore.isValid) {
   user = Astro.locals.pb.authStore.model
}

if (Astro.request.method === 'POST'){
    try {
        const data = await Astro.request.formData()
        
        const cookie = await login(
            data.get("email")?.toString(),
            data.get("password")?.toString(),
        );
        Astro.locals.pb.authStore.loadFromCookie(cookie)
        if (Astro.locals.pb.authStore.isValid) {
            Astro.request.headers.append("Set-Cookie", cookie);
            user = Astro.locals.pb.authStore.model
        }
    } catch (e) {
        console.log(e);
        error = e.message
    }
}


---
<html>
    <head>
        <title>Login Page</title>
    </head>
    <body>
        <main>
            <Layout>
                {user 
                ? 
                    <div>
                        <p> Logged in as {user.email}</p>
                        <p> Name {user.name}</p>
                        <p> Id {user.id}</p>
                        <p> Username {user.username}</p>
                        <a href="/todos">Go to todos</a>    
                    </div>
                :
                    <form method="post">
                        {error ? <p>{error}</p> : null}
                        <input type="text" name="email" placeholder="email">
                        <input type="password" name="password" placeholder="password">
                        <input type="submit" name="submit" value="submit">
                    </form>
                }
            </Layout>
        </main>
    </body>
</html>